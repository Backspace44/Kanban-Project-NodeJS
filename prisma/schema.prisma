generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum ProjectRole {
  OWNER
  MEMBER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REVOKED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  ARCHIVED
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  role         Role          @default(USER)
  createdAt    DateTime      @default(now())

  profile      UserProfile?
  ownedProjects Project[]    @relation("ProjectOwner")
  memberships  ProjectMember[]
  createdTasks Task[]        @relation("TaskCreator")
  assignedTasks Task[]       @relation("TaskAssignee")
  comments     Comment[]
  activity     ActivityLog[]
  invitationsSent Invitation[] @relation("InvitationsSent")

  @@index([role])
}

model UserProfile {
  id          String   @id @default(cuid())
  displayName String
  avatarUrl   String?
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Project {
  id        String      @id @default(cuid())
  name      String
  createdAt DateTime    @default(now())
  ownerId   String
  owner     User        @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  members   ProjectMember[]
  columns   Column[]
  labels    Label[]
  invites   Invitation[]
  activity  ActivityLog[]

  @@index([ownerId])
  @@index([createdAt])
}

model ProjectMember {
  id          String      @id @default(cuid())
  projectId   String
  userId      String
  projectRole ProjectRole @default(MEMBER)
  joinedAt    DateTime    @default(now())

  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId])
}

model Column {
  id        String   @id @default(cuid())
  title     String
  position  Int
  projectId String
  createdAt DateTime @default(now())

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([projectId, position])
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  position    Int
  status      TaskStatus @default(TODO)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  columnId    String
  column      Column     @relation(fields: [columnId], references: [id], onDelete: Cascade)

  creatorId   String
  creator     User       @relation("TaskCreator", fields: [creatorId], references: [id], onDelete: Restrict)

  assigneeId  String?
  assignee    User?      @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  comments    Comment[]
  labels      TaskLabel[]
  activityLogs ActivityLog[] @relation("TaskActivity")

  @@index([columnId, position])
  @@index([assigneeId])
  @@index([status])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())

  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
}

model Label {
  id        String   @id @default(cuid())
  name      String
  color     String?
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  tasks     TaskLabel[]

  @@unique([projectId, name])
  @@index([projectId])
}

model TaskLabel {
  id      String @id @default(cuid())
  taskId  String
  labelId String

  task    Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  label   Label  @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([taskId, labelId])
  @@index([labelId])
}

model Invitation {
  id        String           @id @default(cuid())
  email     String
  token     String           @unique
  status    InvitationStatus @default(PENDING)
  createdAt DateTime         @default(now())

  projectId String
  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  invitedById String
  invitedBy   User           @relation("InvitationsSent", fields: [invitedById], references: [id], onDelete: Cascade)

  @@index([projectId, status])
  @@index([email])
}

model ActivityLog {
  id        String   @id @default(cuid())
  action    String
  details   Json?
  createdAt DateTime @default(now())

  actorId   String
  actor     User     @relation(fields: [actorId], references: [id], onDelete: Cascade)

  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  taskId    String?
  task      Task?    @relation("TaskActivity", fields: [taskId], references: [id], onDelete: SetNull)

  @@index([projectId, createdAt])
  @@index([taskId])
}
